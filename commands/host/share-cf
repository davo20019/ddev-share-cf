#!/usr/bin/env bash

## Description: Share your DDEV site publicly via Cloudflare Tunnel
## Usage: share-cf [flags]
## Example: "ddev share-cf" or "ddev share-cf --tunnel my-project"

#ddev-generated

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Detect OS and architecture
detect_system() {
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    ARCH=$(uname -m)

    # Check if running in WSL
    IS_WSL=false
    if grep -qiE 'microsoft|wsl' /proc/version 2>/dev/null; then
        IS_WSL=true
    fi

    case "$OS" in
        linux*)
            OS_TYPE="linux"
            ;;
        darwin*)
            OS_TYPE="macos"
            ;;
        mingw*|msys*|cygwin*)
            OS_TYPE="windows"
            ;;
        *)
            OS_TYPE="unknown"
            ;;
    esac

    case "$ARCH" in
        x86_64|amd64)
            ARCH_TYPE="amd64"
            ;;
        aarch64|arm64)
            ARCH_TYPE="arm64"
            ;;
        armv7l)
            ARCH_TYPE="arm"
            ;;
        *)
            ARCH_TYPE="unknown"
            ;;
    esac
}

# Show installation instructions based on detected OS
show_install_instructions() {
    echo ""
    echo -e "${RED}‚ùå cloudflared is not installed on your system${NC}"
    echo ""
    echo -e "${YELLOW}üì¶ Installation Instructions:${NC}"
    echo ""

    case "$OS_TYPE" in
        macos)
            echo -e "${CYAN}macOS (Homebrew):${NC}"
            echo -e "  ${BLUE}brew install cloudflared${NC}"
            echo ""
            echo -e "${CYAN}macOS (Manual):${NC}"
            if [[ "$ARCH_TYPE" == "arm64" ]]; then
                echo -e "  ${BLUE}curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-darwin-arm64.tgz -o cloudflared.tgz${NC}"
            else
                echo -e "  ${BLUE}curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-darwin-amd64.tgz -o cloudflared.tgz${NC}"
            fi
            echo -e "  ${BLUE}tar -xzf cloudflared.tgz${NC}"
            echo -e "  ${BLUE}sudo mv cloudflared /usr/local/bin/cloudflared${NC}"
            echo -e "  ${BLUE}sudo chmod +x /usr/local/bin/cloudflared${NC}"
            ;;
        linux)
            if [ "$IS_WSL" = true ]; then
                echo -e "${CYAN}‚úÖ WSL2 detected - Install cloudflared in WSL2:${NC}"
                echo ""
            fi
            echo -e "${CYAN}Debian/Ubuntu:${NC}"
            echo -e "  ${BLUE}curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${ARCH_TYPE}.deb -o cloudflared.deb${NC}"
            echo -e "  ${BLUE}sudo dpkg -i cloudflared.deb${NC}"
            echo ""
            echo -e "${CYAN}RHEL/CentOS/Fedora:${NC}"
            echo -e "  ${BLUE}curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${ARCH_TYPE}.rpm -o cloudflared.rpm${NC}"
            echo -e "  ${BLUE}sudo rpm -i cloudflared.rpm${NC}"
            echo ""
            echo -e "${CYAN}Other Linux (Manual):${NC}"
            echo -e "  ${BLUE}curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${ARCH_TYPE} -o cloudflared${NC}"
            echo -e "  ${BLUE}sudo mv cloudflared /usr/local/bin/cloudflared${NC}"
            echo -e "  ${BLUE}sudo chmod +x /usr/local/bin/cloudflared${NC}"
            ;;
        windows)
            echo -e "${CYAN}Windows (WSL2):${NC}"
            echo -e "  ${YELLOW}‚ö†Ô∏è  Note: This addon requires WSL2. You must install cloudflared in WSL2, not on Windows.${NC}"
            echo -e "  ${BLUE}If you see this message, you're likely running from Windows instead of WSL2.${NC}"
            echo ""
            echo -e "${CYAN}Install cloudflared in WSL2 (run in WSL2 terminal):${NC}"
            echo -e "  ${BLUE}curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${ARCH_TYPE}.deb -o cloudflared.deb${NC}"
            echo -e "  ${BLUE}sudo dpkg -i cloudflared.deb${NC}"
            ;;
        *)
            echo -e "${CYAN}Unknown OS - Manual Installation:${NC}"
            echo -e "  Visit: ${BLUE}https://github.com/cloudflare/cloudflared/releases/latest${NC}"
            ;;
    esac

    echo ""
    echo -e "${YELLOW}üìö More info: ${BLUE}https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/downloads/${NC}"
    echo ""
}

# Check if cloudflared is installed
if ! command -v cloudflared &> /dev/null; then
    detect_system
    show_install_instructions
    exit 1
fi

# --- Argument parsing ---
TUNNEL_NAME=""
CREATE_TUNNEL_NAME=""
DELETE_TUNNEL_NAME=""
HOSTNAME=""
LOGIN=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --tunnel|-t)
            if [[ -z "${2:-}" || "$2" == --* ]]; then
                echo -e "${RED}‚ùå --tunnel requires a tunnel name${NC}"
                exit 1
            fi
            TUNNEL_NAME="$2"
            shift 2
            ;;
        --login)
            LOGIN=true
            shift
            ;;
        --create-tunnel)
            if [[ -z "${2:-}" || "$2" == --* ]]; then
                echo -e "${RED}‚ùå --create-tunnel requires a tunnel name${NC}"
                exit 1
            fi
            CREATE_TUNNEL_NAME="$2"
            shift 2
            ;;
        --hostname)
            if [[ -z "${2:-}" || "$2" == --* ]]; then
                echo -e "${RED}‚ùå --hostname requires a hostname${NC}"
                exit 1
            fi
            HOSTNAME="$2"
            shift 2
            ;;
        --delete-tunnel)
            if [[ -z "${2:-}" || "$2" == --* ]]; then
                echo -e "${RED}‚ùå --delete-tunnel requires a tunnel name${NC}"
                exit 1
            fi
            DELETE_TUNNEL_NAME="$2"
            shift 2
            ;;
        *)
            echo -e "${RED}‚ùå Unknown option: $1${NC}"
            echo ""
            echo "Usage: ddev share-cf [flags]"
            echo ""
            echo "Flags:"
            echo "  --tunnel, -t <name>         Use a named tunnel"
            echo "  --login                     Authenticate with Cloudflare"
            echo "  --create-tunnel <name>      Create a new named tunnel"
            echo "  --hostname <host>           Hostname for DNS routing (used with --create-tunnel)"
            echo "  --delete-tunnel <name>      Delete a named tunnel"
            exit 1
            ;;
    esac
done

# --- Validate flag combinations ---
if [ -n "$HOSTNAME" ] && [ -z "$CREATE_TUNNEL_NAME" ]; then
    echo -e "${RED}‚ùå --hostname can only be used with --create-tunnel${NC}"
    echo -e "${YELLOW}   Example: ddev share-cf --create-tunnel my-project --hostname dev.example.com${NC}"
    exit 1
fi

# --- Handler: --login ---
if [ "$LOGIN" = true ]; then
    CERT_PATH="${HOME}/.cloudflared/cert.pem"
    if [ -f "$CERT_PATH" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  You are already authenticated with Cloudflare${NC}"
        echo -e "${CYAN}   Certificate found at: ${CERT_PATH}${NC}"
        echo -e "${YELLOW}   To re-authenticate, delete the certificate and run this command again:${NC}"
        echo -e "${BLUE}   rm ${CERT_PATH}${NC}"
        echo ""
    fi
    echo -e "${BLUE}üîë Opening browser for Cloudflare authentication...${NC}"
    cloudflared tunnel login
    echo ""
    echo -e "${GREEN}‚úÖ Authentication successful!${NC}"
    echo -e "${CYAN}   You can now create named tunnels with: ddev share-cf --create-tunnel <name> --hostname <host>${NC}"
    exit 0
fi

# --- Handler: --create-tunnel ---
if [ -n "$CREATE_TUNNEL_NAME" ]; then
    CERT_PATH="${HOME}/.cloudflared/cert.pem"
    if [ ! -f "$CERT_PATH" ]; then
        echo -e "${RED}‚ùå Not authenticated with Cloudflare${NC}"
        echo -e "${YELLOW}   Run 'ddev share-cf --login' first to authenticate${NC}"
        exit 1
    fi

    echo -e "${BLUE}üîß Creating tunnel '${CREATE_TUNNEL_NAME}'...${NC}"
    cloudflared tunnel create "$CREATE_TUNNEL_NAME"
    echo ""
    echo -e "${GREEN}‚úÖ Tunnel '${CREATE_TUNNEL_NAME}' created successfully${NC}"

    if [ -n "$HOSTNAME" ]; then
        echo ""
        echo -e "${BLUE}üåê Routing DNS for ${HOSTNAME} to tunnel '${CREATE_TUNNEL_NAME}'...${NC}"
        cloudflared tunnel route dns "$CREATE_TUNNEL_NAME" "$HOSTNAME"
        echo ""
        echo -e "${GREEN}‚úÖ DNS route created: ${HOSTNAME} ‚Üí tunnel '${CREATE_TUNNEL_NAME}'${NC}"
        echo ""
        echo -e "${CYAN}üìã Summary:${NC}"
        echo -e "${CYAN}   Tunnel name: ${CREATE_TUNNEL_NAME}${NC}"
        echo -e "${CYAN}   Hostname:    ${HOSTNAME}${NC}"
        echo -e "${CYAN}   Stable URL:  https://${HOSTNAME}${NC}"
        echo ""
        echo -e "${YELLOW}üí° Note: DNS propagation may take a few minutes${NC}"
    else
        echo ""
        echo -e "${YELLOW}üí° Tip: Add a DNS route with:${NC}"
        echo -e "${BLUE}   ddev share-cf --create-tunnel ${CREATE_TUNNEL_NAME} --hostname dev.example.com${NC}"
    fi

    echo ""
    echo -e "${CYAN}üöÄ Start the tunnel with:${NC}"
    echo -e "${BLUE}   ddev share-cf --tunnel ${CREATE_TUNNEL_NAME}${NC}"
    exit 0
fi

# --- Handler: --delete-tunnel ---
if [ -n "$DELETE_TUNNEL_NAME" ]; then
    echo -e "${BLUE}üóëÔ∏è  Deleting tunnel '${DELETE_TUNNEL_NAME}'...${NC}"
    cloudflared tunnel delete "$DELETE_TUNNEL_NAME"
    echo ""
    echo -e "${GREEN}‚úÖ Tunnel '${DELETE_TUNNEL_NAME}' deleted${NC}"
    exit 0
fi

# --- From here on, we need a running DDEV project ---
if [ -z "$DDEV_HOST_HTTP_PORT" ]; then
    echo -e "${RED}‚ùå Could not determine DDEV local port URL${NC}"
    echo -e "${YELLOW}Make sure you're in a DDEV project directory and the project is running${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ cloudflared is installed${NC}"
echo ""
DDEV_LOCALHOST_URL="http://127.0.0.1:${DDEV_HOST_HTTP_PORT}"

# Detect Drupal multisite setup
SITES_PHP_PATH=""
MULTISITE_DETECTED=false
if [ -f "web/sites/sites.php" ]; then
    SITES_PHP_PATH="web/sites/sites.php"
    MULTISITE_DETECTED=true
elif [ -f "docroot/sites/sites.php" ]; then
    SITES_PHP_PATH="docroot/sites/sites.php"
    MULTISITE_DETECTED=true
fi

# Detect WordPress installation
WORDPRESS_DETECTED=false
if [ "$DDEV_PROJECT_TYPE" = "wordpress" ]; then
    WORDPRESS_DETECTED=true
fi

# Detect Magento installation
MAGENTO_DETECTED=false
if [ "$DDEV_PROJECT_TYPE" = "magento" ] || [ "$DDEV_PROJECT_TYPE" = "magento2" ]; then
    MAGENTO_DETECTED=true
fi

# --- Handler: --tunnel (named tunnel) ---
if [ -n "$TUNNEL_NAME" ]; then
    echo -e "${BLUE}üöÄ Starting named tunnel '${TUNNEL_NAME}'...${NC}"
    echo ""
    echo -e "${CYAN}üìç Local site: ${DDEV_LOCALHOST_URL}${NC}"
    echo ""

    # Verify tunnel exists
    TUNNEL_LIST_OUTPUT=$(cloudflared tunnel list 2>&1) || {
        echo -e "${RED}‚ùå Failed to list tunnels. Are you authenticated?${NC}"
        echo -e "${YELLOW}   Run 'ddev share-cf --login' first${NC}"
        exit 1
    }
    if ! echo "$TUNNEL_LIST_OUTPUT" | grep -qF "$TUNNEL_NAME"; then
        echo -e "${RED}‚ùå Tunnel '${TUNNEL_NAME}' not found${NC}"
        echo -e "${YELLOW}   Create it first with: ddev share-cf --create-tunnel ${TUNNEL_NAME} --hostname dev.example.com${NC}"
        exit 1
    fi

    echo -e "${YELLOW}üí° Tip: Press Ctrl+C to stop the tunnel${NC}"

    if [ "$MULTISITE_DETECTED" = true ]; then
        echo -e "${CYAN}‚ÑπÔ∏è  Drupal multisite detected${NC}"
        echo -e "${YELLOW}üìù Note: Add the tunnel hostname to ${SITES_PHP_PATH}${NC}"
    fi

    if [ "$WORDPRESS_DETECTED" = true ]; then
        echo -e "${CYAN}‚ÑπÔ∏è  WordPress detected${NC}"
        echo -e "${YELLOW}‚ö†Ô∏è  Note: With a named tunnel you can set the URL once and reuse it${NC}"
        echo -e "${YELLOW}   ddev wp option update home 'https://your-tunnel-hostname'${NC}"
        echo -e "${YELLOW}   ddev wp option update siteurl 'https://your-tunnel-hostname'${NC}"
    fi

    if [ "$MAGENTO_DETECTED" = true ]; then
        echo -e "${CYAN}‚ÑπÔ∏è  Magento detected${NC}"
        echo -e "${YELLOW}‚ö†Ô∏è  Note: With a named tunnel you can set the URL once and reuse it${NC}"
        echo -e "${YELLOW}   ddev exec bin/magento config:set web/unsecure/base_url 'https://your-tunnel-hostname/'${NC}"
        echo -e "${YELLOW}   ddev exec bin/magento config:set web/secure/base_url 'https://your-tunnel-hostname/'${NC}"
        echo -e "${YELLOW}   ddev exec bin/magento cache:flush${NC}"
    fi

    echo ""

    cloudflared tunnel run --url "${DDEV_LOCALHOST_URL}" "$TUNNEL_NAME"
    exit 0
fi

# --- Default: quick tunnel (existing behavior) ---
echo -e "${BLUE}üöÄ Starting Cloudflare Tunnel...${NC}"
echo -e "${YELLOW}‚è≥ Generating public URL (this may take a few seconds)...${NC}"
echo ""
echo -e "${CYAN}üìç Local site: ${DDEV_LOCALHOST_URL}${NC}"
echo ""
echo -e "${YELLOW}üí° Tip: Press Ctrl+C to stop the tunnel${NC}"

if [ "$MULTISITE_DETECTED" = true ]; then
    echo -e "${CYAN}‚ÑπÔ∏è  Drupal multisite detected${NC}"
    echo -e "${YELLOW}üìù Note: Add the tunnel URL to ${SITES_PHP_PATH}${NC}"
    echo -e "${YELLOW}   Example: \$sites['tunnel-url.trycloudflare.com'] = 'subsite';${NC}"
fi

if [ "$WORDPRESS_DETECTED" = true ]; then
    echo -e "${CYAN}‚ÑπÔ∏è  WordPress detected${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Note: WordPress redirects may use the local domain instead of tunnel URL${NC}"
    echo -e "${YELLOW}   To fix, update URLs after tunnel starts:${NC}"
    echo -e "${YELLOW}   ddev wp option update home 'https://your-tunnel-url.trycloudflare.com'${NC}"
    echo -e "${YELLOW}   ddev wp option update siteurl 'https://your-tunnel-url.trycloudflare.com'${NC}"
fi

if [ "$MAGENTO_DETECTED" = true ]; then
    echo -e "${CYAN}‚ÑπÔ∏è  Magento detected${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Note: Magento redirects may use the local domain instead of tunnel URL${NC}"
    echo -e "${YELLOW}   To fix, update base URLs after tunnel starts:${NC}"
    echo -e "${YELLOW}   ddev exec bin/magento config:set web/unsecure/base_url 'https://your-tunnel-url.trycloudflare.com/'${NC}"
    echo -e "${YELLOW}   ddev exec bin/magento config:set web/secure/base_url 'https://your-tunnel-url.trycloudflare.com/'${NC}"
    echo -e "${YELLOW}   ddev exec bin/magento cache:flush${NC}"
fi

echo ""

# Start the tunnel pointing to the DDEV site
# cloudflared passes the tunnel URL as the Host header by default, which works for both
# multisite (matched in sites.php) and regular sites (trusted via X-Forwarded-Host)
if [ "$MULTISITE_DETECTED" = true ]; then
    echo -e "${CYAN}üí° Multisite mode: Host header will be the tunnel URL${NC}"
    echo ""
fi

cloudflared tunnel --url "${DDEV_LOCALHOST_URL}"
